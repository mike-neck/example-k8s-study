amends "./MyMod.pkl"

import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.1.1#/api/batch/v1/Job.pkl"
import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.1.1#/api/batch/v1/JobSpec.pkl"

local jobName = "long-running-job"
local thisJobSpec: JobSpec = jobSpec

local imageName = cimgBase
local task = taskScript

local jobLabel = new Mapping {
  ["run"] = jobName
}

repeatTaskCount = null

local job = new Job {
  metadata {
    labels = jobLabel
    name = jobName
  }
  spec = (thisJobSpec) {
    template {
      metadata {
        labels = jobLabel
        generateName = "\(jobName)-"
      }
      spec {
        restartPolicy = "OnFailure"
        containers {
          new {
            image = imageName
            name = jobName
            command {
              "bash"
              "-c"
              task
            }
          }
        }
      }
    }
  }
}

output {
  value = new Listing { job }
}
