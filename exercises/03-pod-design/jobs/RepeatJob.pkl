amends "./MyMod.pkl"

import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.1.1#/api/batch/v1/Job.pkl"
import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.1.1#/api/batch/v1/JobSpec.pkl"

jobName = "long-running-job"
timeoutSeconds = null
repeatTaskCount = 5
local thisJobSpec: JobSpec = jobSpec()
waitInterval = 1
local task = taskScript()
local jobLabel = jobLabel()

local imageName = cimgBase

local job = new Job {
  metadata {
    labels = jobLabel
    name = jobName
  }
  spec = (thisJobSpec) {
    template {
      metadata {
        labels = jobLabel
        generateName = jobName + "-"
      }
      spec {
        restartPolicy = "OnFailure"
        containers {
          new {
            image = imageName
            name = jobName
            command {
              "bash"
              "-c"
              task
            }
          }
        }
      }
    }
  }
}

output {
  value = new Listing<Job> {
    job
  }
}
